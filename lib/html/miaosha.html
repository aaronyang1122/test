<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0" />
		<title></title>
		<link rel="stylesheet" type="text/css" href="../css/less/miaosha.css"/>
		<script type="text/javascript" src="http://api.map.baidu.com/api?v=1.4"></script>
	</head>
	<body>
		<div class="wrap">
			<div class="loading" id="loading">
				<span class="icon-loading"></span>
				<span class="text">加载中...</span>
			</div>
		</div>
		
		<div id="popCate" class="popCate">
			<div id="J_pop" class="J_pop">
				<div id="baiduMap">
					<a href="#" id="closeBtn">closeBtn</a>
					<div id="mapWrap"></div>
				</div>
			</div>
		</div>
		
		<script src="../js/jquery-2.2.3.min.js"></script>
		<script src="../js/jquery.lazyload.min.js"></script>
		<script src="../js/handlebars.runtime-v4.0.5.js"></script>
		<script src="../js/fastclick.min.js"></script>
		<script src="http://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
		<script src="../js/layer.m.js"></script>
		<script src="../js/swipeSlide.min.js"></script>
		<script src="../js/datepicker.js"></script>
		<script src="../js/main.js"></script>
		<script src="../js/helper.js"></script>
		<script src="../js/miaosha.hbs.js"></script>
		<script src="../js/selectChangci.hbs.js"></script>
		<script>
			// 注册页面参数
		var _initPageParam = {
			// 每次载入页面获取当前页面的初始化参数
			getSS: function(){
				return _method.SS._get("queryParams");
			}
		}
//	var _localParam = _method.objSort(["cityId","lat","lng","pageNo","pageSize","sortType","yearsFrom","yearsTo"],_initPageParam.getSS());
		var _localParam = _initPageParam.getSS()?_initPageParam.getSS():{};
		
		// 提交参数
		var _submitParam = {
			userId: _localParam.userId?_localParam.userId:null,
			sign: _localParam.sign?_localParam.sign:null,
			skuId: _method.getQueryString("skuId")
		};
		
		//map
    var paramMap = {};

		// 注册页面内容
		var _init = {
			detail: {
				// 查询课程列表
				"_url": "http://www.imiaoxiu.com/babypass-server/shopSecKill/secKillQuery",
				"_type": "GET",
				"_data": {
					  id: _method.getQueryString("skuId"),
					  lat: _localParam.lat,
					  lng: _localParam.lng
				},
				"_callback": {
					"success": function(res){
						// 写入distance
//						res.data.distance = _method.getQueryString("distance");
						// 初始化默认场次参数
//						var _getResParam = {
//							shopName: res.data.shop.name,
//							branchName: res.data.shop.branchName,
//							appointDate: res.data.recentSkuTimes[0].date,
//							timeFrom: res.data.recentSkuTimes[0].from,
//							skuTimeId: res.data.recentSkuTimes[0].id,
//							childDiscountPrice: res.data.childDiscountPrice, 
//							discountPrice: res.data.discountPrice,
//							isMerchantAlwaysOK: res.data.isMerchantAlwaysOK
//						}
//						for(x in _getResParam){
//							_submitParam[x] = _getResParam[x];
//						}
						// baidu 经纬度
						paramMap.lng = res.data.lng;
						paramMap.lat = res.data.lat;
						// 渲染页面
						$(".wrap").prepend(Handlebars.templates.miaosha(res.data));
						//倒计时
						_method.timer._start(res.data.startTime,function(){
							// 秒杀时间到
							if(res.data.totalNum <= res.data.saledNum){
								// 售完
								$("#countDown").html("<div class=\"mask\"></div>" + "<span class=\"sold-out\"></span>" + "<input type=\"button\" value=\"已秒完\" class=\"submit_null\" disabled=\"disabled\" />");
							}else{
								$("#countDown").html("<input type=\"button\" id=\"submit\" value=\"立即秒杀\" class=\"submit\" />");
							}
						});
						//slide init
						$('.slide').swipeSlide({
							autoSwipe: true,
							continuousScroll: true,
							lazyLoad: true,
							transitionType: 'cubic-bezier(0.22, 0.69, 0.72, 0.88)',
							firstCallback: function(i, sum, me) {
								me.find('.dot').children().first().addClass('cur');
							},
							callback: function(i, sum, me) {
								me.find('.dot').children().eq(i).addClass('cur').siblings().removeClass('cur');
							}
						});
						// 写入页面title
						_method.reloadTitle(res.data.title);
						// 删除loading
						$("#loading").remove();
					},
					"failed": function(XMLHttpRequest, textStatus, errorThrown){
//						console.log(XMLHttpRequest, textStatus, errorThrown);
					}
				}
			}
		}
		// 提交秒杀
		var _submitMiaosha = {
			_url: "http://www.imiaoxiu.com/babypass-server/shopSecKill/secKill",
			_type: "POST",
			_data: {},
			_callback: {
				success: function(res){
					_resData = res.data.body.data;
					switch(_resData){
						case 41006:
							layer.open({
								style: "width:100%;max-width:240px;font-size:16px;text-align:center;padding:1rem 0 0;",
							    content: "<p>库存不足</p>",
							    btn: ["返回"],
							    shadeClose: true
							});
						break;
						case 41007:
							layer.open({
								style: "width:100%;max-width:240px;font-size:16px;text-align:center;padding:1rem 0 0;",
							    content: "<p>余额不足</p>",
							    btn: ["去充值","返回"],
							    shadeClose: false,
							    yes: function(){
							      window.location.href = "chongzhi.html";
							    }
							});
						break;
						case 41008:
							layer.open({
								style: "width:100%;max-width:240px;font-size:16px;text-align:center;padding:1rem 0 0;",
							    content: "<p>您已经秒杀过</p>",
							    btn: ["返回"],
							    shadeClose: true
							});
						break;
						default:
							layer.open({
								style: "width:100%;max-width:240px;font-size:16px;text-align:center;padding:1rem 0 0;",
							    content: "<p>恭喜你秒杀成功</p>",
							    btn: ["返回"],
							    shadeClose: false,
							    yes: function(){
							      window.location.href = "index.html";
							    }
							});
					}
					
				},
				failed: function(XMLHttpRequest, textStatus, errorThrown){
//			         console.log(XMLHttpRequest, textStatus, errorThrown);
				}
			},
			_query: function(){
				_submitMiaosha._data.cityId =  _localParam.cityId;
				_submitMiaosha._data.sign = _localParam.sign;
				_submitMiaosha._data.skuId = _submitParam.skuId;
			  _submitMiaosha._data.userId = _localParam.userId;
			  _method.getData(this._url,this._callback,this._type,this._data)
			}
		}
		
		// 注册click事件
		var _event = {
			// 显示地图
			baiduMap: function(){
				$(".wrap").on("click", "#showMap" ,function(){
					event.preventDefault();
					$("#baiduMap").show();
					$("#baiduMap").siblings().hide();
					_method.pop_show();
					// 生成地图
					var mp = new BMap.Map("mapWrap",{
					    enableHighResolution: true //是否开启高清
					});
					var point = new BMap.Point(paramMap.lng, paramMap.lat);
					mp.centerAndZoom(point, 20);
					var marker = new BMap.Marker(point);  // 创建标注
					mp.addOverlay(marker); 
					
				});
			},
			// 关闭地图
			closeMap: function(){
				$("#closeBtn").on("click",function(){
					event.preventDefault();
					_method.pop_hide();
				})
			},
			submit: function(){
				$(".wrap").on("click","#submit",function(){
					if(_localParam.sign && _localParam.userId){
						_submitMiaosha._query();
					}else{
					// 未登录
					layer.open({
								style: "width:100%;max-width:240px;font-size:16px;text-align:center;padding:1rem 0 0;",
							  content: "<p>您还没登录</p>",
							  btn: ['登录', '返回'],
						    shadeClose: false,
						    yes: function(){
						      window.location.href = "https://open.weixin.qq.com/connect/oauth2/authorize?appid=wx3fa0c56bd36c7469&redirect_uri=http%3a%2f%2fwww.imiaoxiu.com%2fbabypass-server%2fuser%2fbind%3fcityId%3d1&response_type=code&scope=snsapi_base&state=123#wechat_redirect";
						    }
							});
						
					}
				})
			},
			closeCalendar: function(){
				$("#closeCalendar").on("click",function(){
					event.preventDefault();
					_method.pop_hide();
				})
			}
		}
		
		//dom ready
		$(function(){
			// add fastClick
//			FastClick.attach(document.body);
			// 加载页面内容
			for(var x in _init){
					_method.getData(_init[x]._url, _init[x]._callback , _init[x]._type, _init[x]._data);
			}
			// 加载click事件
			for(var x in _event){
				_event[x]();
			}
		});
		</script>
	</body>
</html>
